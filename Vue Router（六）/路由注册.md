路由的作用就是根据不同的路径映射到不同的视图。我们在用Vue开发的项目的是都会用到`vue-router`。

这个插件支持`hash`、`history`、`abstract`三种路由方式，提供了`<router-link>`和`<router-view>`两种组件。

我们下来看基本的使用例子：

```html
<div id="app">
  <h1>Hello App!</h1>
  <p>
    <!-- 使用 router-link 组件来导航. -->
    <!-- 通过传入 `to` 属性指定链接. -->
    <!-- <router-link> 默认会被渲染成一个 `<a>` 标签 -->
    <router-link to="/foo">Go to Foo</router-link>
    <router-link to="/bar">Go to Bar</router-link>
  </p>
  <!-- 路由出口 -->
  <!-- 路由匹配到的组件将渲染在这里 -->
  <router-view></router-view>
</div>
```

```js
import Vue from 'vue'
import VueRouter from 'vue-router'
import App from './App'

Vue.use(VueRouter)

// 1、定义（路由）组件
// 可以从其他文件 import 进来
const Foo = { template: `<div>foo</div>` }
const Bar = { template: `<div>bar</div>` }

// 2、定义路由
// 每个路由应该映射一个组件。其中"component" 可以是
// 通过 Vue.extend() 创建的组件构造器，
// 或者只是一个组件配置对象。
const routes = [
    { path: '/foo', component: Foo },
    { path: '/bar', component: Bar }
]

// 3、创建router实例，然后传`routes`配置
// 还可以传其他参数
const router = new VueRouter({
    routes
})

// 4、创建和挂载根实例
// 记得要通过 router 配置参数注入路由，
// 从而让整个应用都有路由功能
const app = new Vue({
    el: '#app',
    router(h){
        return h(app)
    }
})
```

这是一个简单的例子，接下来我们开始从`Vue.use(VueRouter)`分析



### 路由注册

Vue从它的设计上就是一个渐进式JavaScript框架，它本身的核心是解决视图的渲染的问题，其它的能力就通过插件的方式来解决。Vue-router就是官方维护的路由插件，在说这个之前，我么现在分析Vue通用的插件注册原理。



#### `Vue.use`

Vue提供了`Vue.use`的全局API来注册这些插件，所有我们先来分析它的实现原理，该方法定义在

> vue/src/core/global-api/use.js

```typescript
export function initUse (Vue: GlobalAPI) {
  Vue.use = function (plugin: Function | Object) {
    const installedPlugins = (this._installedPlugins || (this._installedPlugins = []))
    if (installedPlugins.indexOf(plugin) > -1) {
      return this
    }

    const args = toArray(arguments, 1)
    args.unshift(this)
    if (typeof plugin.install === 'function') {
      plugin.install.apply(plugin, args)
    } else if (typeof plugin === 'function') {
      plugin.apply(null, args)
    }
    installedPlugins.push(plugin)
    return this
  }
}
```

`Vue.use`接受一个`plugin`的参数，并且维护了一个`_installedPlugins`的数组，它存储所有注册过的`plugin`；接着又会判断`plugin`有没有定义`installedPlugins`方法，如果有就调用这个方法，并且该方法执行的第一个参数就是`Vue`；最后把`plugin`存储到`installedPlugins`中。

可以看到Vue提供的插件注册机制很简单，每个插件都需要实现一个静态的`install`方法，当我们执行`Vue.use`注册插件的时候，就会执行这个`install`方法，并且在这个`install`方法的第一个参数我们就可以拿到`Vue`对象，这样的好处就是最为插件的编写方不需要再额外去`import Vue`了。



### 路由安装

Vue-Router的入口文件是`src/index.js`，其中定了`VueRouter`类，也实现了`install`的静态方法；`VueRouter.install = install`，它的定义在

> src/install.js

```typescript
export let _Vue
export function install (Vue) {
  if (install.installed && _Vue === Vue) return
  install.installed = true

  _Vue = Vue

  const isDef = v => v !== undefined

  const registerInstance = (vm, callVal) => {
    let i = vm.$options._parentVnode
    if (isDef(i) && isDef(i = i.data) && isDef(i = i.registerRouteInstance)) {
      i(vm, callVal)
    }
  }

  Vue.mixin({
    beforeCreate () {
      if (isDef(this.$options.router)) {
        this._routerRoot = this
        this._router = this.$options.router
        this._router.init(this)
        Vue.util.defineReactive(this, '_route', this._router.history.current)
      } else {
        this._routerRoot = (this.$parent && this.$parent._routerRoot) || this
      }
      registerInstance(this, this)
    },
    destroyed () {
      registerInstance(this)
    }
  })

  Object.defineProperty(Vue.prototype, '$router', {
    get () { return this._routerRoot._router }
  })

  Object.defineProperty(Vue.prototype, '$route', {
    get () { return this._routerRoot._route }
  })

  Vue.component('RouterView', View)
  Vue.component('RouterLink', Link)

  const strats = Vue.config.optionMergeStrategies
  strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created
}
```

